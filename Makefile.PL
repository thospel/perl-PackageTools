#!/usr/bin/perl -w
# $Id: Makefile.PL 3116 2008-07-14 09:00:00Z hospelt $
use 5.008000;
use strict;
use warnings;
use ExtUtils::MakeMaker;
use Config qw(%Config);

our $VERSION = '1.001';

# Allows to suppress all program installation with -n (library only)
use Getopt::Std;
our ($opt_n, $opt_y);
getopts("ny") || die "Usage: $0 [-n] [-y]\n";

my @programs_to_install;

if (!$opt_n || $opt_y) {
    print <<EOT

This package comes with a programs that I can try
to install in $Config{installscript}.

   Note that you can avoid this question by passing
   the '-n' or '-y' option to 'Makefile.PL'.

EOT
if !$opt_y;
    push @programs_to_install, "bin/release_pm" if
        $opt_y ||
        prompt("Install release_pm, a simple version manager ?", "y") =~ /^y/i;
    push @programs_to_install, "bin/makeppd.pl" if
        $opt_y ||
        prompt("Install makeppd.pl, a simple ppd generator ?", "y") =~ /^y/i;
}

WriteMakefile
    (NAME		=> 'PackageTools',
     VERSION_FROM	=> 'lib/PackageTools/Package.pm', # finds $VERSION
     PREREQ_PM		=> {
	 "Test::More"		=> "0.01",	# Only for the tests
     },
     ABSTRACT		=> 'lib/PackageTools.pm',
     AUTHOR		=> 'Ton Hospel <PackageTools@ton.iguana.be>',
     PL_FILES		=> {},
     EXE_FILES		=> \@programs_to_install,
     $^O eq "MSWin32" ? (
         PM_FILTER	=> '$(PERL) -p -e1',
     ) : (),
     clean		=> {
         FILES => '$(DISTNAME).ppd ppm cover_db',
     },
     );

# START MY
# autogenerated by release_pm
BEGIN {
package MY;
use vars qw(%postamble);

$postamble{ppm} = <<'EOF';
ppm: $(DISTNAME).ppd
EOF

$postamble{ppd} = <<'EOF';
$(DISTNAME).ppd: all ppd
	makeppd.pl "--perl=$(PERL)" --min_version=1.013 "--zip=$(ZIP)" "--tar=$(TAR)" "--compress=$(COMPRESS)" --leave=ppm "--objects=$(OBJECT)" $(DISTNAME).ppd $(VERSION)
EOF

$postamble{cover} = <<'EOF';
cover:
	cover -delete
	-HARNESS_PERL_SWITCHES=-MDevel::Cover make test
	cover
EOF

$postamble{ppm_install} = <<'EOF';
ppm_install: $(DISTNAME).ppd
	ppm install ppm/$(DISTNAME).ppd
EOF

$postamble{ppm_uninstall} = <<'EOF';
ppm_uninstall:
	ppm uninstall $(DISTNAME)
EOF

sub postamble {
    return shift->SUPER::postamble() . join("
", @postamble{sort {uc $a cmp uc $b || $a cmp $b } keys %postamble});
}
}
# END MY

BEGIN {
package MY;
our %postamble;
$postamble{ppd} = <<'EOF';
$(DISTNAME).ppd: all ppd
	$(PERL) bin/makeppd.pl "--zip=$(ZIP)" "--tar=$(TAR)" "--compress=$(COMPRESS)" --leave=ppm $(DISTNAME).ppd $(VERSION)
EOF
}
